<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="author" content="Tao Di">
		<meta http-equiv="cache-control" content="max-age=0">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT">
		<meta http-equiv="pragma" content="no-cache">
		<title>Rack elevation</title>
		<!-- bootstrap 3 -->
		<link href="static/css/bootstrap.css" rel="stylesheet">
		<!-- bootstrap-datetimepicker -->
		<link href="static/css/daterangepicker.css" rel="stylesheet">
		<!-- x-editable (bootstrap 3) -->
		<link href="static/css/bootstrap-editable.css" rel="stylesheet">
		<link rel="stylesheet" href="static/css/zTreeStyle/zTreeStyle.css" type="text/css">
		
		<link href="static/css/main.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="static/css/demo.css"/>
		<style type="text/css">
			div#rMenu {position:absolute; visibility:hidden; top:0; background-color: #555;text-align: left;padding: 2px;}
			div#rMenu ul li{
				margin: 1px 0;
				padding: 0 5px;
				cursor: pointer;
				list-style: none outside none;
				background-color: #DFDFDF;
			}
		</style>
		<style>
			td{vertical-align: middle;}
		</style>
		<style>
			.file .m-add{display: none;}
			.file .m-del, .file .m-modify, .fold .m-add, .fold .m-del, .fold .m-modify{display: block;}
			.ztree li span.button.fold_ico_open{margin-right:2px; background: url('static/css/zTreeStyle/img/zTreeStandard.png') no-repeat scroll -110px -16px transparent; vertical-align:top; *vertical-align:middle}
			.ztree li span.button.fold_ico_close{margin-right:2px; background: url('static/css/zTreeStyle/img/zTreeStandard.png') no-repeat scroll -110px 0 transparent; vertical-align:top; *vertical-align:middle}
			.ztree li span.button.fold_ico_docu{margin-right:2px; background: url('static/css/zTreeStyle/img/zTreeStandard.png') no-repeat scroll -110px 0 transparent; vertical-align:top; *vertical-align:middle}
			.ztree li span.button.file_ico_docu{margin-right:2px; background: url('static/css/zTreeStyle/img/diy/3.png') no-repeat scroll 0 0 transparent; vertical-align:top; *vertical-align:middle}

		</style>
		<style>
			html,body{
				height: 100%;
				width: 100%;
				overflow: hidden;
			}
			body{
				height: 98%;
			}
	    	#wrap{  
			    min-width:1024px;
			    margin:0 auto;
			    height: 100%;
			}  
			#header{  
			    margin-top:20px;
			    margin-left: 20px;
			    height:80px;
		      	line-height: 80px;
		      	border-bottom: 1px solid #EEEEEE;
			}
			#container{  
			    position:relative;  
			    margin:20px;
			    height: calc(100% - 240px);
			}  
			#left_side{  
			    position:absolute;  
			    top:0px;  
			    left:0px;
			    width:250px;  
			    height:100%;
			    border-right: 1px solid #EEEEEE;
			}  
			#content{  
			    margin:0px 270px 0px 270px;  
			      
			    height:100%;  
			}  
			#right_side{  
			    position:absolute;  
			    top:0px;  
			    right:0px;
			    width:250px;  
			    height:100%;
			    padding-left: 20px;
			    border-left: 1px solid #EEEEEE;
			}  
			#footer{  
			    margin:20px;  
			    height:80px;
		        line-height: 80px;
		        border-top: 1px solid #EEEEEE;
			}  
	    </style>
	    <style>
			.tool-bar{
				float: right;
			}
			.highlightCss{
				font-weight: bold;
			}
			tr td:first-child,
			tr td:last-child{
				width: 20%;
			}
			
			
			#treeDemo,
			.right{
			    overflow: auto;
			    overflow-x: hidden;
			}
			#treeDemo,
			.right{
				height: calc(100% - 44px);
			}
			
			#treeDemo::-webkit-scrollbar,
			.right::-webkit-scrollbar {
				width: 2px;
			}
			#treeDemo::-webkit-scrollbar-track,
			.right::-webkit-scrollbar-track{
				background-color: #EEEEEE;
				-webkit-border-radius: 2em;
				-moz-border-radius: 2em;
				border-radius:2em;
			}
			#treeDemo::-webkit-scrollbar-thumb,
			.right::-webkit-scrollbar-thumb{
				background-color: #808080;
				-webkit-border-radius: 2em;
				-moz-border-radius: 2em;
				border-radius:2em;
			}
		</style>
	</head>
	<body>
		<div id="wrap">
	        <div id="header">
	        	<h1>Rack elevation</h1>
	        	<div style="word-wrap: break-word;float: right;margin-right: 100px;"><span style="color: red;">noty:</span>this place noty!</div>
	        </div>
	        <div id="container">
	            <div id="left_side">
	            	<input type="text" class="form-control" value="" id="in" style="display: inline-block;width: 160px;" placeholder="key value"/>
					<button type="button" class="btn btn-default" id="searchNode" onclick="searchNodes($('#in').val())">search</button>
					<ul id="treeDemo" class="ztree"></ul>
	            </div>
	            <div id="content">
	            	<div class="rack-name">rack 1000</div>
	            	<div class="right" style="height: calc(100% - 41px);overflow: auto;">
						<div style="background: #808080;padding-top: 20px;padding-bottom: 20px;width: 80%;margin: 0 auto;">
							<table id="rackValue" class="" border="2" bordercolor="black" cellspacing="0" cellpadding="5" style="border: 1px solid #000000;text-align: center;vertical-align: middle;width: calc(60% - 20px);margin: 0 auto;"></table>
						</div>
					</div>
	            </div>
				<style>
					#right_side .modify, #right_side .unmerge, #right_side .merge{
						width: 230px;
						margin: 10px auto;
					}
					#right_side .save-rack-info{
						width: 230px;
					}
					.detail .key,
					.info-detail .key{
						float: left;
						width: 50px;
						text-overflow: ellipsis;
						overflow: hidden;
						white-space: nowrap;
						font-size: 14px;
						font-weight: bold;
					}
					.detail .oper,
					.info-detail .oper{
						float: left;
						font-size: 14px;
					}
					.detail .value,
					.info-detail .value{
						width: 130px;
						text-overflow: ellipsis;
						overflow: hidden;
						white-space: nowrap;
						font-size: 14px;
						border: 0px;
					}
				</style>
	            <div id="right_side">
	            	<div class="tool-bar" style="float: left;">
						<div style="position: relative;">
							<button type="button" class="modify btn btn-default" data-toggle="modal" >modify</button>
							<button type="button" class="merge btn btn-default" data-toggle="modal" data-target=".merge-node">merge</button>
							<button type="button" class="unmerge btn btn-default">unmerge</button>
							<div class="unmerge-list hide" style="position: absolute;top: 158px;left: 0;z-index: 10;width: 100%;">
								<ul class="list-group"></ul>
							</div>
						</div>
						<div class="info-detail" style="word-wrap: break-word;margin-top: 40px;">
							<span>Device information</span>
							<ul class="list-group">
								<!--<li class="list-group-item">
									<div class="key">name</div>
									<div class="oper">： </div>
									<input type="text" class="form-control value" value="PEK50-NP-COR-R2" placeholder="name" title="PEK50-NP-COR-R2"/>
								</li>
								<li class="list-group-item">
									<div class="key">model</div>
									<div class="oper">： </div>
									<input type="text" class="form-control value" value="WS-C4900M V12" placeholder="model" title="WS-C4900M V12" />
								</li>
								<li class="list-group-item">
									<div class="key">SN</div>
									<div class="oper">： </div>
									<input type="text" class="form-control value" value="JAE17160807" placeholder="SN" title="JAE17160807" />
								</li>
								<li class="list-group-item">
									<div class="key">asset</div>
									<div class="oper">： </div>
									<input type="text" class="form-control value" value="9901524790" placeholder="asset" title="9901524790" />
								</li>-->
							</ul>
						</div>
						<button type="button" class="save-rack-info btn btn-default">save rack info</button>
					</div>
	            </div>
	        </div>
	        <div id="footer" style="text-align: center;">
	        	<p>amazon © amazon.</p>
	        </div>
	    </div>
		<style>
			.detail{
				position: absolute;
			}
		</style>
		
		<div class="detail hide">
			<ul class="list-group">
				<!--<li class="list-group-item">
					<div class="key">name</div>
					<div class="oper">： </div>
					<div class="value">PEK50-NP-COR-R2</div>
				</li>
				<li class="list-group-item">
					<div class="key">model</div>
					<div class="oper">： </div>
					<div class="value">WS-C4900M V12</div>
				</li>
				<li class="list-group-item">
					<div class="key">SN</div>
					<div class="oper">： </div>
					<div class="value">JAE17160807</div>
				</li>
				<li class="list-group-item">
					<div class="key">asset</div>
					<div class="oper">： </div>
					<div class="value">9901524790</div>
				</li>-->
			</ul>
		</div>
		<div class="main" id="main">
			<div class="alert alert-success alert-dismissible hide" role="alert">
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span></button>
				<strong>Well done!</strong>Successful operation.
			</div>
			<div class="alert alert-warning alert-dismissible hide" role="alert">
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span></button>
				<strong>Wrong!</strong>Operation failed, reference console log.
			</div>
		</div>
		<div id="rMenu">
			<ul>
				<li id="m_add" class="m-add" onclick="addTreeNode();">增加节点</li>
				<li id="m_del" class="m-del" onclick="modifyTreeNode();">修改节点</li>
				<li id="m_modify" class="m-modify" onclick="removeTreeNode();">删除节点</li>
			</ul>
		</div>
		
		<div class="modal fade add-node" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Add New Node</h4>
					</div>
					<div class="modal-body">
						<div class="input-group">
							<span class="input-group-addon">name:</span>
							<input type="text" class="form-control node-name" name="" value="" placeholder="node name" />
						</div>
						<div class="input-group">
							<span class="input-group-addon">type:</span>
							<input type="text" class="form-control node-type" name="" value="" placeholder="node type(0-rack, 1-fold)" />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default cancel" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary sure">Submit</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		
		<div class="modal fade merge-node" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Merge Rack Pos</h4>
					</div>
					<div class="modal-body">
						<div class="input-group">
							<span class="input-group-addon">pos:</span>
							<input type="text" class="form-control merge-pos" name="" value="" placeholder="merge-pos" />
						</div>
						<br />
						<div class="input-group">
							<span class="input-group-addon">len:</span>
							<input type="text" class="form-control merge-len" name="" value="" placeholder="merge-len" />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default cancel" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary sure">Submit</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		
		<div class="modal fade modify-rack-name" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Modify Rack Name</h4>
					</div>
					<div class="modal-body">
						<div class="input-group">
							<span class="input-group-addon">name:</span>
							<input type="text" class="form-control modal-rack-name" name="" value="" placeholder="rack name" />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default cancel" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary sure">Submit</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<!--<script type="text/javascript" src=".js/jquery-1.4.4.min.js"></script>-->
		<script type="text/javascript" src="static/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="static/js/jquery.ztree.all.js"></script>
		<script type="text/javascript" src="static/js/jquery.ztree.exhide.js" ></script>
		<script type="text/javascript" src="static/js/jquery.ztree.search.js"></script>
		
		
		
		<!-- momentjs --> 
		<script type="text/javascript" src="static/js/moment.min.js"></script>
		<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
		<!--[if lt IE 9]>
		<script type="text/javascript" src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<!-- bootstrap 3 -->
		<script type="text/javascript" src="static/js/bootstrap.js"></script>
		<!-- bootstrap-datetimepicker -->
		<script type="text/javascript" src="static/js/daterangepicker.js"></script>
		<!-- x-editable (bootstrap 3) -->
		<script type="text/javascript" src="static/js/bootstrap-editable.js"></script>
		<script type="text/javascript" src="static/js/html2canvas.js"></script>
		<script type="text/javascript" src="static/js/main2.js"></script>
		<script type="text/javascript">
			var ajax_url = {};
			if(window.location.href.indexOf("dev") > -1){
				ajax_url = {
					"getTree": "json/getTree.json",
					"addTree": "json/addTree.json",
					"delTree": "json/delTree.json",
					"modifyTree": "json/modifyTree.json",
					"saveRackName": "json/saveRackName.json",
					"getRack": "json/getRack.json",
					"savedata": "",
					"getPEK50": "/EndOfShiftReport/json/getdataPEK50.json",
					"getPEK7": "/EndOfShiftReport/json/getdataPEK7.json",
					"post": "/EndOfShiftReport/json/savedata.json"
				};
			}else{
				ajax_url = {
					"getTree": "/api/getnodes",
					"addTree": "/api/addnode",
					"delTree": "/api/delnode",// error
					"modifyTree": "/api/modifynode",
					"saveRackName": "/api/saverackname",
					"saveRackInfo": "/api/saverackinfo",
					"saveRackValue": "/api/saverackvalue",
					"getRack": "/api/getrack"
				};
			}
		</script>
		<SCRIPT type="text/javascript">
			var setting = {
				view: {
					dblClickExpand: true,
					showLine: false
				},
				check: {
					enable: false
				},
				data: {
					simpleData: {
						enable: true
					}
				},
				edit: {
					enable: true,
					editNameSelectAll: true,
					showRemoveBtn: false,
					showRenameBtn: false
				},
				callback: {
					onRightClick: OnRightClick,
					beforeEditName: beforeEditName,
					beforeRename: beforeRename,
					onRename: onRename,
					onClick: zTreeOnClick
				},
				highlightCss: {"font-weight":"bold"},
				disHighlightCss: {"font-weight":"inherit"}, 
				delayTime: 500
			};
			
			function OnRightClick(event, treeId, treeNode) {
				var type = treeNode.type || "file";
				if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
					zTree.cancelSelectedNode();
					showRMenu("root", event.clientX, event.clientY, type);
				} else if (treeNode && !treeNode.noR) {
					zTree.selectNode(treeNode);
					showRMenu("node", event.clientX, event.clientY, type);
				}
			}
			
			function beforeEditName(treeId, treeNode) {
				
			}
			
			function beforeRename(treeId, treeNode, newName, isCancel) {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				if (newName.length == 0) {
					zTree.cancelEditName();
					alert("节点名称不能为空.");
					return false;
				}
				var id = zTree.getSelectedNodes()[0].id;
				$.ajax({
					url: ajax_url.modifyTree,
					type: "post",
					async: true,
					data: {
						name: newName,
						id: id
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							$(".add-node").modal("hide");
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
				return true;
			}
			function onRename(e, treeId, treeNode, isCancel) {
				console.log("xxx");
			}
	
	
			function showRMenu(type, x, y, type) {
				$("#rMenu").removeClass("fold").removeClass("file").addClass(type)
				$("#rMenu ul").show();
				if (type=="root") {
					$("#m_del").hide();
					$("#m_check").hide();
					$("#m_unCheck").hide();
				} else {
					$("#m_del").show();
					$("#m_check").show();
					$("#m_unCheck").show();
				}
				rMenu.css({"top":y+"px", "left":x+"px", "visibility":"visible"});
	
				$("body").bind("mousedown", onBodyMouseDown);
			}
			function hideRMenu() {
				if (rMenu) rMenu.css({"visibility": "hidden"});
				$("body").unbind("mousedown", onBodyMouseDown);
			}
			function onBodyMouseDown(event){
				if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length>0)) {
					rMenu.css({"visibility" : "hidden"});
				}
			}
			function addTreeNode() {
				hideRMenu();
				$(".add-node").modal("show");
			}
			
			function modifyTreeNode(){
				hideRMenu();
				var nodes = zTree.getSelectedNodes();
				zTree.editName(nodes[0]);
			}
			
			var rackInfoValue = {
				value: {rackValue:{"1": {id: 1,name: 1,value: {asset: "asset1",x2: "x2",x3: "x3"}}, "2": {id: 2,name: 2,value: {asset: "asset2",x2: "x2",x3: "x3"}}, "3": {id: 3,name: 3,value: {asset: "asset3",x2: "x2",x3: "x3"}}, "4": {id: 4,name: 4,value: {asset: "asset3",x2: "x2",x3: "x3"}}, "5": {id: 5,name: 5,value: {asset: "asset3",x2: "x2",x3: "x3"}}, "6": {id: 6,name: 6,value: {asset: "asset3",x2: "x2",x3: "x3"}},"7": {id: 7,name: 7,value: {asset: "asset3",x2: "x2",x3: "x3"}}, "8": {id: 7,name: 7,value: {asset: "asset3",x2: "x2",x3: "x3"}},"9": {id: 7,name: 7,value: {asset: "asset3",x2: "x2",x3: "x3"}},"10": {id: 7,name: 7,value: {asset: "asset3",x2: "x2",x3: "x3"}}}, mergeData: {"1": {pos: 1,len: 2},"4": {pos: 4,len: 2}}},
				info: {asset: "asset1",x2: "x2",x3: "x3"},
				name: "name",
			};
			
			function zTreeOnClick(ev, id, obj, lev){
				if(obj.type == "fold") return false;
				console.log(obj.id);
				$.ajax({
					url: ajax_url.getRack,
					type: "get",
					async: true,
					data: {
						id: obj.id
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							rackInfoValue.value = JSON.parse(unescape(json.data.value));
							rackInfoValue.info = JSON.parse(unescape(json.data.info));
							rackInfoValue.name = json.data.name;
							drawRack();
							drawMerge();
							$("#content .rack-name").html(rackInfoValue.name);
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
			}
			
			function drawRack(){
				
				var rackValue = rackInfoValue.value.rackValue;
				var rackInfo = rackInfoValue.info;
				$("#rackValue").empty();
				for (var i in rackValue) {
					$("#rackValue").append(
								['<tr data-id="'+rackValue[i].id+'">',
						            '<td>'+rackValue[i].id+'</td>',
						            '<td>name:'+rackValue[i].name+'<br />asset:'+rackValue[i].value.asset+'<br />x1:'+rackValue[i].value.x2+'<br /></td>',  
						            '<td>'+rackValue[i].id+'</td>',
						        '</tr>'].join(""));
				}
				$(".info-detail ul").empty();
				for (var i in rackInfo) {
					$(".info-detail ul").append(
								['<li class="list-group-item">',
									'<div class="key">'+i+'</div>',
									'<div class="oper">： </div>',
									'<input type="text" class="form-control value" value="'+rackInfo[i]+'" placeholder="'+i+'" title="'+rackInfo[i]+'"/>',
								'</li>'].join(""));
				}
			}
			function drawMerge(){
				var mergeData = rackInfoValue.value.mergeData;
				$("#rackValue").find("td").removeAttr("rowspan").removeClass("hide");
				$("#rackValue").find(".td-merge").removeClass("td-merge");
				for(var i in mergeData){
					var pos = parseInt(mergeData[i].pos);
					var len = parseInt(mergeData[i].len);
					$("#rackValue").find("tr:eq("+(pos-1)+") td:eq(1)").attr("rowspan", len).addClass("td-merge");
					$("#rackValue").find("tr:eq("+(pos-1)+") td:eq(1)").css({
						"vertical-align": "middle",
						"text-align": "center"
					});
					for (var l = 0; l < len-1; l++) {
						$("#rackValue").find("tr:eq("+(pos+l)+") td:eq(1)").addClass("hide");
					}
				}
			}
			
			function removeTreeNode() {
				hideRMenu();
				var nodes = zTree.getSelectedNodes();
				if (nodes && nodes.length>0) {
					if (nodes[0].children && nodes[0].children.length > 0) {
						var msg = "要删除的节点是父节点，如果删除将连同子节点一起删掉。\n\n请确认！";
						if (confirm(msg)==true){
							var id = zTree.getSelectedNodes()[0].id;
							$.ajax({
								url: ajax_url.delTree,
								type: "post",
								async: true,
								data: {
									id: id
								},
								dataType: "json",
								timeout: 5000,
								success: function (json) {
									if (json.code == -1 && json.msg == "session-timeout") {
										window.location.reload();
									} else if (json.code == 1) {
										zTree.removeNode(nodes[0]);
										$(".add-node").modal("hide");
									}
								},
								error: function (e) {
									console.error("请求出错(请检查相关网络状况.)", e);
								}
							});
						}
					} else {
						var id = zTree.getSelectedNodes()[0].id;
						$.ajax({
							url: ajax_url.delTree,
							type: "post",
							async: true,
							data: {
								id: id
							},
							dataType: "json",
							timeout: 5000,
							success: function (json) {
								if (json.code == -1 && json.msg == "session-timeout") {
									window.location.reload();
								} else if (json.code == 1) {
									zTree.removeNode(nodes[0]);
									$(".add-node").modal("hide");
								}
							},
							error: function (e) {
								console.error("请求出错(请检查相关网络状况.)", e);
							}
						});
					}
				}
			}
			var zTree, rMenu;
			$(document).ready(function(){
				$.ajax({
					url: ajax_url.getTree,
					type: "get",
					async: true,
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							for (var i = 0; i < json.data.length; i++) {
								json.data[i].iconSkin = json.data[i].type;
							}
							$.fn.zTree.init($("#treeDemo"), setting, json.data);
							zTree = $.fn.zTree.getZTreeObj("treeDemo");
							rMenu = $("#rMenu");
							
							for (var i = 0; i < json.data.length; i++) {
								if(json.data[i].type == "file"){
									var node = zTree.getNodeByParam('id', json.data[i].id);  
					                zTree.selectNode(node);
					                zTree.setting.callback.onClick(null, zTree.setting.treeId, node);
					                break;
								}
							}
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
				
			});
			//-->
			
			$(document).delegate("#rackValue tbody tr", "mousemove", function (ev) {
				var _this = this;
				var dataID = $(_this).data("id");
				var selVal = rackInfoValue.value.rackValue[dataID].value;
				$(".detail ul").empty();
				for(var i in selVal){
					$(".detail ul").append(
							['<li class="list-group-item">',
								'<div class="key">'+i+'</div>',
								'<div class="oper">： </div>',
								'<div class="value">'+selVal[i]+'</div>',
							'</li>'].join(""));
				}
				$(".detail").css("left", ev.clientX+10);
				$(".detail").css("top", ev.clientY+10);
				$(".detail").removeClass("hide");
				
			});
			$(document).delegate("#rackValue tbody tr", "mouseout", function (ev) {
				$(".detail").addClass("hide");
			});
			
			$(document).delegate("#rackValue tbody tr", "click", function (ev) {
				var _this = this;
				var dataID = $(_this).data("id");
				var selVal = rackInfoValue.value.rackValue[dataID].value;
				$(".info-detail ul").empty();
				for(var i in selVal){
					$(".info-detail ul").append(
							['<li class="list-group-item">',
								'<div class="key">'+i+'</div>',
								'<div class="oper">： </div>',
								'<input type="text" class="form-control value" value="'+selVal[i]+'" placeholder="name" title="'+selVal[i]+'">',
							'</li>'].join(""));
				}
			});
			
			$(document).delegate(".modify.btn", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				var rackName = $(".rack-name").text();
				$(".modify-rack-name .modal-rack-name").val(rackName);
				$(".modify-rack-name").modal("show");
			});
			
			$(document).delegate(".modify-rack-name .sure", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				var rackName = $(".modify-rack-name .modal-rack-name").val();
				if(!rackName){
					alert("the name is empty or the type is empty!");
					return false;
				}
				var id = zTree.getSelectedNodes()[0].id;
				$.ajax({
					url: ajax_url.saveRackName,
					type: "post",
					async: true,
					data: {
						id: id,
						name: rackName
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							$(".rack-name").html(rackName);
							$(".modify-rack-name").modal("hide");
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
			});
			
			$(document).delegate(".add-node .sure", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				var _this = this;
				var value = $(".add-node .node-name").val();
				var type = $(".add-node .node-type").val();
				if(!value || !type){
					alert("the name is empty or the type is empty!");
					return false;
				}
				if(type != 0 && type != 1){
					alert("type is wrong,0 is for rack and 1 is for fold!");
					return false;
				}
				if(type == 1) type = "fold";
				if(type == 0) type = "file";
				var id = zTree.getSelectedNodes()[0].id;
				$.ajax({
					url: ajax_url.addTree,
					type: "post",
					async: true,
					data: {
						name: value,
						pId: id,
						type: type,
						rackName: value,
						info: "%7B%22asset%22%3A%22asset1%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D",
						value: "%7B%22rackValue%22%3A%7B%221%22%3A%7B%22id%22%3A1%2C%22name%22%3A1%2C%22value%22%3A%7B%22asset%22%3A%22asset1%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D%7D%2C%222%22%3A%7B%22id%22%3A2%2C%22name%22%3A2%2C%22value%22%3A%7B%22asset%22%3A%22asset2%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D%7D%7D%2C%22mergeData%22%3A%7B%221%22%3A%7B%22pos%22%3A1%2C%22len%22%3A2%7D%2C%224%22%3A%7B%22pos%22%3A4%2C%22len%22%3A2%7D%7D%7D"
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							var newNode = { name: value, iconSkin: type, id: json.data.id };
							if (zTree.getSelectedNodes()[0]) {
								newNode.checked = zTree.getSelectedNodes()[0].checked;
								zTree.addNodes(zTree.getSelectedNodes()[0], newNode);
							} else {
								zTree.addNodes(null, newNode);
							}
							$(".add-node").modal("hide");
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
				
				
			});
			
			function searchNodes(value){
				var allNodesObj = $("#treeDemo .node_name");
				allNodesObj.parents("li").addClass("hide");
				for (var i = 0; i < allNodesObj.length; i++) {
					if($(allNodesObj[i]).text().indexOf($('#in').val()) > -1){
						$(allNodesObj[i]).addClass("highlightCss");
						$(allNodesObj[i]).parents("li").removeClass("hide");
					}
				}
				
				var result = zTree.searchNodes($('#in').val());
				if(result.length == 0){
					$("#treeDemo").find(".no-data").remove();
					$("#treeDemo").prepend("<li class='no-data'>没有搜索到数据</li>");
				}else{
					$("#treeDemo").find(".no-data").remove();
				}
			}
			
			$(document).delegate("#in", "keyup", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				if(ev.keyCode == 13){
					searchNodes($('#in').val())
				}
			});
			
			$(document).delegate(".merge", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				$(".merge-node").removeClass("hide");
			});
			
			$(document).delegate(".unmerge", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				$(".unmerge-list ul").empty();
				var tdMergeObjs = $("#rackValue").find("td.td-merge");
				for (var i = 0; i < tdMergeObjs.length; i++) {
					var id = $(tdMergeObjs[i]).parents("tr").data("id");
					$(".unmerge-list ul").append('<li class="list-group-item" data-id="'+id+'">'+id+'</li>');
				}
				$(".unmerge-list").removeClass("hide");
			});
			
			$(document).delegate(".unmerge-list li", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				var _this = this;
				$(_this).remove();
				var dataID = $(_this).data("id");
				delete rackInfoValue.value.mergeData[dataID];
				drawMerge();
				$(".unmerge-list").addClass("hide");
			});
			
			$(document).delegate(".save-rack-info", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				$.ajax({
					url: ajax_url.saveRackInfo,
					type: "post",
					async: true,
					data: {
						id: id,
						info: "%7B%22asset%22%3A%22asset1%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D"
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
			});
			
			$(document).delegate(".save-rack-value", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				$.ajax({
					url: ajax_url.saveRackValue,
					type: "post",
					async: true,
					data: {
						id: id,
						value: "%7B%22rackValue%22%3A%7B%221%22%3A%7B%22id%22%3A1%2C%22name%22%3A1%2C%22value%22%3A%7B%22asset%22%3A%22asset1%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D%7D%2C%222%22%3A%7B%22id%22%3A2%2C%22name%22%3A2%2C%22value%22%3A%7B%22asset%22%3A%22asset2%22%2C%22x2%22%3A%22x2%22%2C%22x3%22%3A%22x3%22%7D%7D%7D%2C%22mergeData%22%3A%7B%221%22%3A%7B%22pos%22%3A1%2C%22len%22%3A2%7D%2C%224%22%3A%7B%22pos%22%3A4%2C%22len%22%3A2%7D%7D%7D"
					},
					dataType: "json",
					timeout: 5000,
					success: function (json) {
						if (json.code == -1 && json.msg == "session-timeout") {
							window.location.reload();
						} else if (json.code == 1) {
							
						}
					},
					error: function (e) {
						console.error("请求出错(请检查相关网络状况.)", e);
					}
				});
			});
			
			$(document).bind('click',function(ev){
				ev.stopPropagation();
				ev.preventDefault();
				$(".unmerge-list").addClass("hide");
			});
			
			$(document).delegate(".merge-node .sure", "click", function (ev) {
				ev.stopPropagation();
				ev.preventDefault();
				var _this = this;
				var pos = $(".merge-node .merge-pos").val();
				var len = $(".merge-node .merge-len").val();
				if(!pos || !len){
					alert("the pos is empty or the len is empty!");
					return false;
				}
				if(isNaN(pos) || isNaN(len)){
					alert("pos and len are both type of number!");
					return false;
				}
				pos = parseInt(pos);
				len = parseInt(len);
				
				
				if($("#rackValue").find("tr:eq("+(pos-1)+") td:eq(1)").hasClass("hide")){
					console.log("already merge");
					$(".merge-node").modal("hide");
					return false;
				}
				
				for (var i = len-1; i > 0 ; i--) {
					if($("#rackValue").find("tr:eq("+(pos+i)+") td:eq(1)").hasClass("hide")){
						console.log("already merge");
						$(".merge-node").modal("hide");
						return false;
					}else{
						break;
					}
				}
				
				$("#rackValue").find("tr:eq("+(pos-1)+") td:eq(1)").attr("rowspan", len).addClass("td-merge");
				$("#rackValue").find("tr:eq("+(pos-1)+") td:eq(1)").css({
					"vertical-align": "middle",
					"text-align": "center"
				});
				for (var i = 0; i < len-1; i++) {
					$("#rackValue").find("tr:eq("+(pos+i)+") td:eq(1)").addClass("hide");
				}
				
				$(".merge-node").modal("hide");
			});
		</SCRIPT>
	</body>
</html>